<!DOCTYPE html>
{% load static %}
{% load persian_date %}
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اکتشاف محتوا - دکتر همدان</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Fonts -->
    <link href="{% static 'css/fonts.css' %}" rel="stylesheet">
    
    <!-- Meta tags -->
    <meta name="description" content="اکتشاف بهترین محتوای پزشکی از پزشکان متخصص">
    <meta name="keywords" content="پزشک، سلامت، محتوای پزشکی، ویدیو آموزشی">
    
    <style>
        /* Custom styles for Persian UI */
        body {
            font-family: 'IRANSansWeb', Tahoma, Arial, sans-serif;
        }
        
        /* Masonry Grid */
        .masonry-grid {
            column-count: 1;
            column-gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .masonry-grid {
                column-count: 2;
            }
        }
        
        @media (min-width: 768px) {
            .masonry-grid {
                column-count: 3;
            }
        }
        
        @media (min-width: 1024px) {
            .masonry-grid {
                column-count: 4;
            }
        }
        
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
            display: inline-block;
            width: 100%;
        }
        
        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Smooth animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Search input focus */
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* RTL adjustments */
        .rtl-flip {
            transform: scaleX(-1);
        }
        
        /* Stats cards */
        .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="{% url 'doctors:doctor_list' %}" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">د</span>
                    </div>
                    <span class="text-xl font-bold text-gray-900">دکتر همدان</span>
                </a>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="{% url 'doctors:doctor_list' %}" class="text-gray-600 hover:text-blue-600 transition-colors">
                        پزشکان
                    </a>
                    <a href="{% url 'clinics:clinic_list' %}" class="text-gray-600 hover:text-blue-600 transition-colors">
                        کلینیک‌ها
                    </a>
                    <a href="{% url 'doctors:explore' %}" class="text-blue-600 font-medium">
                        اکتشاف
                    </a>
                </div>
                
                <!-- User Menu -->
                {% if user.is_authenticated %}
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-600">{{ user.phone }}</span>
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 text-sm font-medium">{{ user.first_name|first|default:"کاربر"|first }}</span>
                        </div>
                    </div>
                {% else %}
                    <a href="{% url 'account:register' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ورود
                    </a>
                {% endif %}
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">اکتشاف محتوای پزشکی</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                بهترین مقالات، ویدیوها و نکات پزشکی را از متخصصان برتر کشور مطالعه کنید
            </p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stats-card bg-white rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-blue-600">{{ stats.total_posts }}</div>
                <div class="text-sm text-gray-600">کل پست‌ها</div>
            </div>
            <div class="stats-card bg-white rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-green-600">{{ stats.video_posts }}</div>
                <div class="text-sm text-gray-600">ویدیوها</div>
            </div>
            <div class="stats-card bg-white rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-purple-600">{{ stats.image_posts }}</div>
                <div class="text-sm text-gray-600">تصاویر</div>
            </div>
            <div class="stats-card bg-white rounded-xl p-4 text-center">
                <div class="text-2xl font-bold text-indigo-600">{{ stats.doctors_count }}</div>
                <div class="text-sm text-gray-600">پزشکان</div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search Input -->
                <div class="md:col-span-2">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            placeholder="جستجو در عنوان، محتوا، یا نام پزشک..."
                            value="{{ search_query }}"
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent search-input transition-all duration-200"
                        >
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Media Type Filter -->
                <div>
                    <select id="mediaTypeFilter" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all" {% if media_type == 'all' %}selected{% endif %}>همه محتوا</option>
                        <option value="video" {% if media_type == 'video' %}selected{% endif %}>ویدیوها</option>
                        <option value="image" {% if media_type == 'image' %}selected{% endif %}>تصاویر</option>
                        <option value="none" {% if media_type == 'none' %}selected{% endif %}>متن‌ها</option>
                    </select>
                </div>
                
                <!-- Specialty Filter -->
                <div>
                    <select id="specialtyFilter" class="w-full py-3 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">همه تخصص‌ها</option>
                        {% for spec in specializations %}
                            <option value="{{ spec }}" {% if specialty == spec %}selected{% endif %}>{{ spec }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Posts Grid -->
        <div class="masonry-grid" id="postsGrid">
            {% include 'index/explore_posts_partial.html' with posts=posts %}
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-8">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">در حال بارگیری...</p>
        </div>

        <!-- Load More Button -->
        {% if posts.has_next %}
        <div class="text-center mt-8">
            <button 
                id="loadMoreBtn" 
                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium"
                data-next-page="{{ posts.next_page_number }}"
            >
                مشاهده بیشتر
            </button>
        </div>
        {% endif %}

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="mb-4">
                <svg class="w-24 h-24 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <h3 class="text-xl font-medium text-gray-900 mb-2">محتوایی یافت نشد</h3>
            <p class="text-gray-500 mb-6">متأسفانه محتوایی با این فیلترها پیدا نشد. لطفاً جستجوی دیگری امتحان کنید.</p>
            <button onclick="clearFilters()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                پاک کردن فیلترها
            </button>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-lg">د</span>
                        </div>
                        <span class="text-xl font-bold text-gray-900">دکتر همدان</span>
                    </div>
                    <p class="text-sm text-gray-500">دسترسی به خدمات درمانی را برای همه آسان و راحت می‌کنیم.</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">خدمات</h4>
                    <ul class="space-y-2">
                        <li><a href="{% url 'doctors:doctor_list' %}" class="text-sm text-gray-500 hover:text-blue-600">پیدا کردن پزشک</a></li>
                        <li><a href="{% url 'clinics:clinic_list' %}" class="text-sm text-gray-500 hover:text-blue-600">کلینیک‌ها</a></li>
                        <li><a href="{% url 'doctors:explore' %}" class="text-sm text-gray-500 hover:text-blue-600">اکتشاف محتوا</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">شرکت</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-sm text-gray-500 hover:text-blue-600">درباره ما</a></li>
                        <li><a href="#" class="text-sm text-gray-500 hover:text-blue-600">تماس با ما</a></li>
                        <li><a href="#" class="text-sm text-gray-500 hover:text-blue-600">بلاگ</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">قوانین</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-sm text-gray-500 hover:text-blue-600">حریم خصوصی</a></li>
                        <li><a href="#" class="text-sm text-gray-500 hover:text-blue-600">شرایط استفاده</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-100 mt-8 pt-8 text-center">
                <p class="text-sm text-gray-500">&copy; {% now "Y" %} دکتر همدان. تمامی حقوق محفوظ است.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        let currentPage = {{ posts.number }};
        let hasNextPage = {{ posts.has_next|yesno:"true,false" }};
        let totalPages = {{ posts.paginator.num_pages }};
        let isLoading = false;
        let searchTimeout;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const mediaTypeFilter = document.getElementById('mediaTypeFilter');
        const specialtyFilter = document.getElementById('specialtyFilter');
        const postsGrid = document.getElementById('postsGrid');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');

        // Search functionality
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 500);
        });

        // Filter change handlers
        mediaTypeFilter.addEventListener('change', performSearch);
        specialtyFilter.addEventListener('change', performSearch);

        // Load more button
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', loadMorePosts);
        }

        // Perform search/filter
        function performSearch() {
            if (isLoading) return;
            
            const searchQuery = searchInput.value.trim();
            const mediaType = mediaTypeFilter.value;
            const specialty = specialtyFilter.value;
            
            // Reset pagination
            currentPage = 1;
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('search', searchQuery);
            url.searchParams.set('media_type', mediaType);
            url.searchParams.set('specialty', specialty);
            url.searchParams.delete('page');
            window.history.pushState({}, '', url);
            
            loadPosts(true);
        }

        // Load more posts
        function loadMorePosts() {
            if (isLoading || !hasNextPage) return;
            
            currentPage++;
            loadPosts(false);
        }

        // Load posts via AJAX
        function loadPosts(resetGrid = false) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            const searchQuery = searchInput.value.trim();
            const mediaType = mediaTypeFilter.value;
            const specialty = specialtyFilter.value;
            
            const params = new URLSearchParams({
                search: searchQuery,
                media_type: mediaType,
                specialty: specialty,
                page: currentPage
            });
            
            fetch(`{% url 'doctors:explore' %}?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (resetGrid) {
                        postsGrid.innerHTML = data.posts_html;
                    } else {
                        postsGrid.innerHTML += data.posts_html;
                    }
                    
                    hasNextPage = data.has_next;
                    totalPages = data.total_pages;
                    
                    // Update load more button
                    updateLoadMoreButton();
                    
                    // Show empty state if no posts
                    if (data.total_count === 0) {
                        showEmptyState();
                    } else {
                        hideEmptyState();
                    }
                    
                    // Add fade-in animation to new posts
                    const newPosts = postsGrid.querySelectorAll('.masonry-item:not(.fade-in)');
                    newPosts.forEach(post => {
                        post.classList.add('fade-in');
                    });
                } else {
                    showError('خطا در بارگیری محتوا');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('خطا در ارتباط با سرور');
            })
            .finally(() => {
                isLoading = false;
                hideLoading();
            });
        }

        // UI Helper Functions
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            if (loadMoreBtn) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'در حال بارگیری...';
            }
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function updateLoadMoreButton() {
            if (!loadMoreBtn) return;
            
            if (hasNextPage) {
                loadMoreBtn.classList.remove('hidden');
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'مشاهده بیشتر';
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        function showEmptyState() {
            emptyState.classList.remove('hidden');
            postsGrid.classList.add('hidden');
        }

        function hideEmptyState() {
            emptyState.classList.add('hidden');
            postsGrid.classList.remove('hidden');
        }

        function showError(message) {
            // Simple error display - could be enhanced with a toast system
            alert(message);
        }

        function clearFilters() {
            searchInput.value = '';
            mediaTypeFilter.value = 'all';
            specialtyFilter.value = '';
            
            // Update URL
            const url = new URL(window.location);
            url.search = '';
            window.history.pushState({}, '', url);
            
            performSearch();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                clearFilters();
            } else if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Focus search input on load
            if (window.innerWidth > 768) {
                searchInput.focus();
            }
            
            // Add fade-in animation to initial posts
            const initialPosts = postsGrid.querySelectorAll('.masonry-item');
            initialPosts.forEach((post, index) => {
                setTimeout(() => {
                    post.classList.add('fade-in');
                }, index * 50);
            });
        });
    </script>
</body>
</html>
