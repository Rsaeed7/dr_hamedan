{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">{{ chat_room.title }}</h1>
    <div id="chat-messages" class="space-y-2 mb-4">
        {% for message in messages %}
        <div class="p-2 rounded {% if message.sender.is_staff %}bg-green-100{% else %}bg-blue-100{% endif %}">
            <strong>{{ message.sender.username }}:</strong> {{ message.content }}
            <small class="text-gray-500">{{ message.created_at|date:"SHORT_DATE_FORMAT" }} {{ message.created_at|time:"H:i" }}</small>
        </div>
        {% endfor %}
    </div>
    <form id="message-form" method="post" action="{% url 'about:send_message' chat_room.id %}">
        {% csrf_token %}
        <div class="flex">
            <input type="text" name="content" placeholder="Type your message..." class="flex-grow p-2 border rounded-l">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r">Send</button>
        </div>
    </form>
</div>

<script>
  const roomId = "{{ chat_room.id }}";
if (!roomId) {
    console.error("Room ID is missing!");
    // Handle the error (e.g., show a message to the user)
} else {
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    chatSocket.onopen = function() {
        console.log("WebSocket connection established.");
    };

    chatSocket.onclose = function(e) {
        console.error("WebSocket connection closed:", e);
        // Optionally, try to reconnect or notify the user
    };

    chatSocket.onerror = function(error) {
        console.error("WebSocket error:", error);
        // Notify the user or try to reconnect
    };

    chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const messageElement = document.createElement('div');
    messageElement.classList.add('p-2', 'rounded');
    if (data.sender_is_admin) {
        messageElement.classList.add('bg-green-100');
    } else {
        messageElement.classList.add('bg-blue-100');
    }
    messageElement.innerHTML = `<strong>${data.sender}:</strong> ${data.message} <small class="text-gray-500">${data.timestamp}</small>`;
    document.getElementById('chat-messages').appendChild(messageElement);

    // Scroll to the bottom
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = this.querySelector('input[name="content"]').value.trim();
        if (content) {
            chatSocket.send(JSON.stringify({
                'message': content
            }));
            this.querySelector('input[name="content"]').value = '';
        } else {
            console.warn("Message content is empty!");
        }
    });
}
</script>
{% endblock %}
