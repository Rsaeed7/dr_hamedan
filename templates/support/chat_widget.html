<style>
    #chat-widget {
        position: fixed;
        bottom: 1px;
        left: 0px;
        z-index: 1050;
    }

    #chat-icon {
        width: 50px;
        height: 45px;
        background: none;
        background-color: rgba(30, 68, 96, 0.82);
        color: #fdfdfd;
        border-bottom-right-radius: 20px;
        border-top-right-radius: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        font-size: 24px;
        transition: all 0.3s ease;
    }

    #chat-content {
        display: none;
        margin-top: 10px;
        transform: translateY(100%);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.2s ease;
    }

    #chat-content.show {
        display: block;
        transform: translateY(0);
        opacity: 1;
    }

    .card {
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    #chat-container {
        transition: all 0.3s ease;
    }

    @media (max-width: 767px) {
        #chat-widget {
            bottom: 73px;
        }
    }

    .rounded_pill {
        border-radius: 50px !important;
    }
    .rounded50 {
        border-radius: 50%;
    }
    .dr_bg {
        background-color: #1e4460;
    }
</style>

<div id="chat-widget">
    <!-- Ø¢ÛŒÚ©ÙˆÙ† Ú†Øª -->
    <div id="chat-icon"><span class="status-indicator"></span>
       <i class="pe-7s-headphones fs-30" id="chat-toggle"></i>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ú†Øª -->
    <div id="chat-content">
        <div class="card">
            <div id="chat-header" class="dr_bg d-flex text-white rounded-top" style="height: 50px; cursor:pointer;">
                <i class="icon-cancel"></i>
                <p id="chat-toggle-icon p-r-50"><i class="m-t-15 pe-7s-headphones"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ØªØ±Ù‡Ù…Ø¯Ø§Ù† </p>

            </div>
            {% if request.user.is_authenticated %}
            <div id="chat-container" class="card-body p-0" style="height: 400px;width: 300px">
                <div id="chat-messages" class="p-3" style="height: calc(100% - 62px); background-color: #f8f9fa;overflow: auto!important;"></div>
                <div class="border-top p-2">
                    <form id="chat-form" class="d-flex">
                        <input type="text" id="chat-input" placeholder="Ù¾ÛŒØ§Ù… Ø´Ù…Ø§..." class="form-control rounded_pill" autocomplete="off" required>
                        <button type="submit" class="btn btn-scroll rounded50 icon-left-big text-secondary border justify-content-center p-t-10"></button>
                    </form>
                </div>
            </div>
            {% else %}
                <div id="chat-container" class="card-body p-0" style="height: 250px;width: 300px">
                <div class="border-top p-2">
                    <input disabled type="text"  placeholder="Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯" class="form-control rounded_pill ">
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatToggle = document.getElementById('chat-toggle');
    const chatContent = document.getElementById('chat-content');
    const chatIcon = document.getElementById('chat-icon');
    const chatHeader = document.getElementById('chat-header');

    let chatSocket = null;

    // Ø§Ø¨ØªØ¯Ø§ Ú†Øª Ù…Ø®ÙÛŒ Ø§Ø³Øª
    chatContent.style.display = 'none';

    // ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª
function appendMessage(data) {
    const messageEl = document.createElement('div');
    messageEl.classList.add('p-2', 'rounded', 'mb-2');
    if (data.sender_is_admin) {
        messageEl.classList.add('bg-light-green', 'text-end');
        messageEl.innerHTML = `<strong>Ø§Ø¯Ù…ÛŒÙ†:</strong> ${data.message || data.content}`;
    } else {
        messageEl.classList.add('bg-light-blue', 'text-start');
        messageEl.innerHTML = `<strong>Ø´Ù…Ø§:</strong> ${data.message || data.content}`;
    }

    if (data.is_welcome) {
        // ğŸ‘ˆ Ù¾ÛŒØ§Ù… Ø®ÙˆØ´Ø§Ù…Ø¯ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ù„ÛŒØ³Øª
        chatMessages.insertBefore(messageEl, chatMessages.firstChild);
    } else {
        chatMessages.appendChild(messageEl);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
}


    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¢ÛŒÚ©ÙˆÙ†
    chatToggle.addEventListener('click', function () {
        chatContent.style.display = 'block';
        setTimeout(() => {
            chatContent.classList.add('show');
        }, 10);
        chatIcon.style.display = 'none';

        // Ø§Ú¯Ø± ÙˆØ¨â€ŒØ³ÙˆÚ©Øª Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡ØŒ Ø¨Ø³Ø§Ø² Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
        if (!chatSocket) {
            fetch('/api/chat/messages/')
                .then(response => response.json())
                .then(data => {
                    chatMessages.innerHTML = '';  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
                    data.messages.forEach(msg => {
                        appendMessage(msg);
                    });
                })
                .catch(error => {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:', error);
                });

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            chatSocket = new WebSocket(protocol + '://' + window.location.host + '/ws/chat/support/');

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                appendMessage(data);
            };

            chatSocket.onclose = function (e) {
                console.error('WebSocket Ù‚Ø·Ø¹ Ø´Ø¯:', e);
            };

            chatSocket.onerror = function (e) {
                console.error('WebSocket Ø®Ø·Ø§:', e);
            };
        }
    });

    // Ø¨Ø³ØªÙ† Ú†Øª Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù‡Ø¯Ø±
    chatHeader.addEventListener('click', function () {
        chatContent.classList.remove('show');
        setTimeout(() => {
            chatContent.style.display = 'none';
            chatIcon.style.display = 'flex';
        }, 300); // Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ù…Ø¯Øª Ø²Ù…Ø§Ù† transition
    });

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;

        chatSocket.send(JSON.stringify({'message': message}));
        chatInput.value = '';
    });
});
</script>