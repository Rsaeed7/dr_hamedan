{% extends 'base/base.html' %}
{% load static %}
{% block body %}
    <div class="filters_listing">
        <div class="container">
            <ul class="clearfix">
                <form method="post" action="list.html">
                    <div id="custom-search-input">
                        <div class="input-group">
                            <input type="text" class="search-query" placeholder="نام یا تخصص....">
                            <input type="submit" class="btn_search" style="border-radius: 50px" value="جستجو">
                        </div>
                    </div>
                </form>
            </ul>
        </div>
    </div>
    <!-- /search -->

    <div class="container margin_60">
        <div class="row">
            <div class="col-xl-8 col-lg-8 order-2 order-lg-1">
                <div id="section_1">
                    <div>
                        <div>
                            <div class="tab-content box_general_3 p-m-1">
                                <div class="tab-pane fade show active text-center" id="book" role="tabpanel"
                                     aria-labelledby="book-tab">
                                    <!-- Step 1: Select Day -->
                                    <div class="flex bg-bluelight p-t-20 p-b-0 rounded" id="day-selection">
                                        <button class="btn-scroll2 icon-right-open-big" id="slideRight"
                                                type="button"></button>
                                        <div id="contain" class="form-group add_bottom_45 flex scrollable">
                                            {% for day in days %}
                                                <div class="w-auto mx-2 my-2 day-card" data-date="{{ day.date|date:'Y-m-d' }}" 
                                                     data-display="{{ day.date|date:'l j F' }}">
                                                    <button class="btn btn-outline-dark spacer day-btn"
                                                            style="height: 70px;width: 80px">
                                                        <div>{{ day.date|date:"l" }}</div>
                                                        <div>{{ day.date|date:"j F" }}</div>
                                                        <small>{{ day.slots|length }} نوبت</small>
                                                    </button>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button id="slideLeft" class="btn-scroll2 icon-left-open-big" type="button"></button>
                                    </div>

                                    <!-- Step 2: Select Time -->
                                    <div class="w-full m-t-20" id="time-selection" style="display: none;">
                                        <div class="h-auto w-auto mx-2">
                                            <div class="flex justify-between items-center mb-3">
                                                <button class="btn btn-outline-secondary back-to-days">
                                                    <i class="fas fa-arrow-right"></i> بازگشت
                                                </button>
                                                <h4 id="selected-day-title" class="mb-0"></h4>
                                            </div>
                                            
                                            <div class="form-group add_bottom_45 row mx-4 turn-group" id="time-slots">
                                                <!-- Time slots will be loaded here -->
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Booking Form -->
                                    <div id="booking-form" style="display: none;">
                                        <div class="flex justify-between items-center mb-3">
                                            <button class="btn btn-outline-secondary back-to-times">
                                                <i class="fas fa-arrow-right"></i> بازگشت
                                            </button>
                                            <h4>تکمیل اطلاعات نوبت</h4>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <p class="mb-2">شما در حال رزرو نوبت برای:</p>
                                            <p class="fw-bold mb-1" id="appointment-date-time"></p>
                                            <p class="mb-0">هزینه ویزیت: {{ doctor.consultation_fee }} تومان</p>
                                        </div>

                                        <form method="post" id="resform" style="margin-top: 20px">
                                            {% csrf_token %}
                                            <input type="hidden" name="date" id="form-date">
                                            <input type="hidden" name="time" id="form-time">

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>نام<span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" id="name" name="name" 
                                                               value="{% if request.user.is_authenticated %}{{ request.user.get_full_name }}{% endif %}" required>
                                                        <small class="text-danger font-weight-light" id="name_alarm"></small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>شماره موبایل<span class="text-danger">*</span></label>
                                                        <input type="tel" class="form-control" id="phone" name="phone" required>
                                                        <small class="text-danger font-weight-light" id="phone_alarm"></small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>کد ملی<span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" id="meli_code" name="meli_code">
                                                        <small class="text-danger font-weight-light" id="code_alarm"></small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="custom-gender-toggle">
                                                        <input type="radio" id="male-option" name="gender" value="M" checked>
                                                        <label for="male-option">آقا هستم</label>
                                                        <input type="radio" id="female-option" name="gender" value="F">
                                                        <label for="female-option">خانم هستم</label>
                                                        <div class="custom-slider"></div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12 centered">
                                                    <button type="submit" class="btn btn-info dr_bg m-t-20 w-full rounded">
                                                        ثبت نوبت
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- aside -->
            <aside class="col-xl-4 col-lg-4 order-1 order-lg-2">
                <div class="profile box_general_3">
                    <div class="row parent-container">
                        <div class="col-lg-12 col-md-4">
                            <figure>
                                <a class="dr_box2">
                                    <img src="{{ doctor.image.url }}" alt="" class="dr_img">
                                    <i class="icon-star-5 text-primary"><small>4.3</small></i>
                                </a>
                            </figure>
                        </div>
                        <div class="col-lg-12 col-md-12">
                            <div class="text-center">
                                <h1>دکتر {{ doctor.user.get_full_name }}</h1>
                                <small>{{ doctor.specialty }}</small>
                            </div>
                        </div>
{#                        <a class="btn btn-outline-info col-lg-12" href="{% url 'core:dr_detail' doctor.id %}">پروفایل پزشک</a>#}
                    </div>
                </div>
            </aside>
        </div>
    </div>

{#    <style>#}
{#        .day-card {#}
{#            cursor: pointer;#}
{#            transition: all 0.3s;#}
{#        }#}
{#        .day-card:hover {#}
{#            transform: translateY(-5px);#}
{#        }#}
{#        .time-slot-btn {#}
{#            margin: 5px;#}
{#            min-width: 80px;#}
{#        }#}
{#        .step {#}
{#            display: none;#}
{#        }#}
{#        .step.active {#}
{#            display: block;#}
{#            animation: fadeIn 0.5s;#}
{#        }#}
{#        @keyframes fadeIn {#}
{#            from { opacity: 0; }#}
{#            to { opacity: 1; }#}
{#        }#}
{#        .custom-gender-toggle {#}
{#            position: relative;#}
{#            display: inline-block;#}
{#            margin-top: 20px;#}
{#        }#}
{#        .custom-slider {#}
{#            position: absolute;#}
{#            background-color: #4CAF50;#}
{#            transition: .4s;#}
{#            border-radius: 34px;#}
{#        }#}
{#    </style>#}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            let selectedDay = null;
            let selectedDayDisplay = '';
            
            // انتخاب روز
            $('.day-card').click(function() {
                selectedDay = $(this).data('date');
                selectedDayDisplay = $(this).data('display');
                
                $('#selected-day-title').text(selectedDayDisplay);
                $('#time-slots').empty();
                
                // پیدا کردن زمان‌های خالی برای روز انتخاب شده
                const daySlots = [];
                {% for day in days %}
                    if ("{{ day.date|date:'Y-m-d' }}" === selectedDay) {
                        {% for slot in day.slots %}
                            daySlots.push("{{ slot|time:'H:i' }}");
                        {% endfor %}
                    }
                {% endfor %}
                
                if (daySlots.length > 0) {
                    daySlots.forEach(function(slot) {
                        const timeParts = slot.split(':');
                        const hour = parseInt(timeParts[0]);
                        const minute = timeParts[1];
                        const ampm = hour >= 12 ? 'ب.ظ' : 'ق.ظ';
                        const hour12 = hour % 12 || 12;
                        const timeDisplay = hour12 + ':' + minute + ' ' + ampm;
                        
                        $('#time-slots').append(`
                            <div class="col-md-3 col-6 mb-3">
                                <button class="btn btn-outline-success time-slot-btn time-slot" 
                                        data-time="${slot}"
                                        data-display="${timeDisplay}">
                                    ${timeDisplay}
                                </button>
                            </div>
                        `);
                    });
                } else {
                    $('#time-slots').html(`
                        <div class="col-12">
                            <div class="alert alert-warning text-center">
                                متاسفانه در این روز نوبت خالی وجود ندارد
                            </div>
                        </div>
                    `);
                }
                
                // نمایش مرحله انتخاب زمان
                $('#day-selection').hide();
                $('#time-selection').show();
            });
            
            // انتخاب زمان
            $(document).on('click', '.time-slot', function() {
                const time = $(this).data('time');
                const timeDisplay = $(this).data('display');
                
                $('#form-date').val(selectedDay);
                $('#form-time').val(time);
                $('#appointment-date-time').text(selectedDayDisplay + ' ساعت ' + timeDisplay);
                
                // نمایش فرم ثبت نوبت
                $('#time-selection').hide();
                $('#booking-form').show();
            });
            
            // بازگشت به انتخاب روز
            $('.back-to-days').click(function() {
                $('#time-selection').hide();
                $('#day-selection').show();
            });
            
            // بازگشت به انتخاب زمان
            $('.back-to-times').click(function() {
                $('#booking-form').hide();
                $('#time-selection').show();
            });
            
            // اعتبارسنجی فرم
            $('#resform').submit(function(e) {
                const name = $('#name').val().trim();
                const phone = $('#phone').val().trim();
                const meli_code = $('#meli_code').val().trim();
                
                // Reset error messages
                $('.text-danger').text('');
                $('.form-control').removeClass('border-danger');
                
                let isValid = true;
                
                if (name.length < 3) {
                    $('#name').addClass('border-danger');
                    $('#name_alarm').text('نام شما حداقل باید 3 حرف داشته باشد!');
                    isValid = false;
                }
                
                if (phone.length !== 11 || !/^0\d{10}$/.test(phone)) {
                    $('#phone').addClass('border-danger');
                    $('#phone_alarm').text('شماره تلفن باید 11 رقم باشد و با 0 شروع شود');
                    isValid = false;
                }
                
                if (meli_code.length !== 10 || !/^\d{10}$/.test(meli_code)) {
                    $('#meli_code').addClass('border-danger');
                    $('#code_alarm').text('کد ملی 10 رقمی صحیح وارد کنید!');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                }
            });
            
            // اسکرول افقی برای روزها
            const rightButton = $('#slideRight');
            const leftButton = $('#slideLeft');
            const contain = $('#contain');
            
            rightButton.on("mousedown", function() {
                contain.animate({scrollLeft: '+=350'}, 300);
            });
            
            leftButton.on("mousedown", function() {
                contain.animate({scrollLeft: '-=350'}, 300);
            });
        });
    </script>
{% endblock %}