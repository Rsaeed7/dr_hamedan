{% extends 'base/base.html' %}
{% load static %}
{% block title %}<title>رزرو نوبت | دکتر همدان</title>{% endblock %}
{% block body %}
{% load persian_date %}
{% block style %}
    <link href="{% static 'css/booking/calendar.css' %}" rel="stylesheet">
{% endblock %}
{% include  'base/search.html' %}
    <!-- /search -->

    <div class="container margin_60 bg-gradiant">
        <div class="row">
            <div class="col-xl-8 col-lg-8 order-2 order-lg-1">
                <div id="section_1">
                    <div class="tab-content box_general_3 border-0 shadow-0-m p-m-1">
                        {% if days %}

                            <div class="tab-pane fade show active text-center" id="book" role="tabpanel">

                                <div class="calendar-container">
                                    <div class="calendar-header">
                                        <button class="calendar-nav-btn" id="prev-month">
                                            <i class="icon-right-1 p-t-5"></i>
                                        </button>
                                        <div class="calendar-title" id="month-year"></div>
                                        <button class="calendar-nav-btn " id="next-month">
                                            <i class="icon-left-1 p-t-5"></i>
                                        </button>
                                    </div>

                                    <div class="calendar-body" id="calendar-grid">
                                        <!-- روزها به صورت دینامیک توسط جاوااسکریپت پر می‌شوند -->
                                    </div>
                                </div>

                                <!-- Time Slots Section -->
                                <div class="mt-3" id="time-slots-main" style="display: none;">
                                    <div class="mb-3 text-center" id="selected-date-display">
                                        <span id="selected-date-text" class="h5 text_dr_3"></span>
                                        <div id="available-slots-count" class="small"></div>

                                        <div class="row m-t-10" id="time-slots-grid" onclick="showFormModal()">
                                            <!-- زمان‌های ویزیت در اینجا بارگذاری می‌شوند -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Patient Information Form -->
                                <div class="hidden scroll-wrapper" id="information">
                                    <div id="formModal" class="modal text-right">
                                        <div class="modal-content">
                                            <span class="close" onclick="closeFormModal()">&times;</span>
                                            <div id="booking-form">
                                                <div class="alert alert-info mt-3">
                                                    شما در حال رزرو نوبت برای: <strong
                                                        id="appointment-date-time"></strong><br>
                                                    هزینه دریافت نوبت: {{ doctor.consultation_fee }} تومان
                                                </div>
                                                <form method="post" id="booking-form">
                                                    {% csrf_token %}
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="patient_name" class="form-label">نام<span
                                                                        class="text-red">*</span></label>
                                                                <input type="text" id="patient_name" name="patient_name"
                                                                       class="form-control" value="{% if user.first_name %}{{ user.first_name }}{% endif %}"
                                                                       required>
                                                                <small class="text-danger font-weight-light"
                                                                       id="name_alarm"></small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="patient_last_name" class="form-label">نام
                                                                    خانوادگی<span class="text-red">*</span></label>
                                                                <input type="text" id="patient_last_name"
                                                                       name="patient_last_name"
                                                                       class="form-control" value="{% if user.last_name %}{{ user.last_name }}{% endif %}"
                                                                       required>
                                                                <small class="text-danger font-weight-light"
                                                                       id="last_name_alarm"></small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="patient_national_id" class="form-label">کد
                                                                    ملی <span
                                                                            class="text-red">*</span></label>
                                                                <input type="text" id="patient_national_id"
                                                                       name="patient_national_id"
                                                                       class="form-control"
                                                                       value="{{ patient_info.national_id }}">
                                                                <small class="text-danger font-weight-light"
                                                                       id="code_alarm"></small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="phone" class="form-label">شماره تماس<span
                                                                        class="text-red">*</span></label>
                                                                <input type="tel" id="phone" name="phone"
                                                                       class="form-control" required value="{% if user.phone %}{{ user.phone }}{% endif %}">
                                                                <small class="text-danger font-weight-light"
                                                                       id="phone_alarm"></small>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="custom-gender-toggle">
                                                                <input type="radio" id="male-option" name="gender"
                                                                       value="M"
                                                                       checked>
                                                                <label for="male-option">آقا هستم</label>
                                                                <input type="radio" id="female-option" name="gender"
                                                                       value="F">
                                                                <label for="female-option">خانم هستم</label>
                                                                <div class="custom-slider"></div>
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <input type="hidden" name="date" id="selected_date" required>
                                                    <input type="hidden" name="time" id="selected_time" required>

                                                    <!-- Payment Method Choice -->
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <label class="form-label">روش پرداخت</label>
                                                            <div class="payment-method-options">
                                                                <div class="payment-option">
                                                                    <input type="radio" id="direct-payment"
                                                                           name="payment_method" value="direct" checked>
                                                                    <label for="direct-payment"
                                                                           class="payment-option-label">
                                                                        <div class="payment-option-content">
                                                                            <div class="payment-option-icon">
                                                                                <i class="icon-credit-card"></i>
                                                                            </div>
                                                                            <div class="payment-option-text">
                                                                                <div class="payment-option-title">پرداخت
                                                                                    مستقیم
                                                                                </div>
                                                                                <div class="payment-option-description">
                                                                                    از طریق درگاه پرداخت
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                                <div class="payment-option">
                                                                    <input type="radio" id="wallet-payment"
                                                                           name="payment_method" value="wallet">
                                                                    <label for="wallet-payment"
                                                                           class="payment-option-label">
                                                                        <div class="payment-option-content">
                                                                            <div class="payment-option-icon">
                                                                                <i class="icon-wallet"></i>
                                                                            </div>
                                                                            <div class="payment-option-text">
                                                                                <div class="payment-option-title">پرداخت
                                                                                    از کیف پول
                                                                                </div>
                                                                                <div class="payment-option-description">
                                                                                    از موجودی کیف پول استفاده کنید
                                                                                </div>
                                                                                <div class="payment-option-balance"
                                                                                     id="wallet-balance-display">
                                                                                    موجودی: <span
                                                                                        id="current-balance">{{ balance|default:0 }}</span>
                                                                                    تومان
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <button type="submit" id="submit-btn"
                                                            class="btn btn-secondary w-100"
                                                            disabled>
                                                        لطفاً تاریخ و زمان را انتخاب کنید
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        {% else %}
                            <p class="box_general bg-light-yellow text-center icon-attention-alt-1">در حال حاضر نوبت
                                فعالی برای این پزشک وجود ندارد</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- سایدبار پزشک -->
            <aside class="col-xl-4 col-lg-4 order-1 order-lg-2">
                <div class="profile box_general_3 border-0">
                    <div class="row parent-container">
                        <div class="col-lg-12 col-md-4">
                            <figure>
                                <a class="dr_box2">
                                    {% if doctor.profile_image.name %}
                                        <img src="{{ doctor.profile_image.url }}" alt="{{ doctor.user.get_full_name }}"
                                             class="dr_img">
                                    {% else %}
                                        <div class="dr_img"
                                             style="background-color: #e5e7eb; display: flex; align-items: center; justify-content: center;">
                                            <i class="icon-user" style="font-size: 48px; color: #9ca3af;"></i>
                                        </div>
                                    {% endif %}
                                    <i class="icon-star-5 text-primary"><small>{{ doctor.comment_rate }}</small></i>
                                </a>
                            </figure>
                        </div>
                        <div class="col-lg-12 col-md-12 text-center">
                            <h1>دکتر {{ doctor.user.get_full_name }}</h1>
                            <small>تخصص : {{ doctor.specialization }} </small>
                            <p class="text-gray-600 fs-12">هزینه دریافت نوبت : {{ doctor.consultation_fee }} </p>
                        </div>
                        <a class="btn btn-outline-info col-lg-12 m-b-5"
                           href="{% url 'doctors:doctor_detail' doctor.slug %}">پروفایل
                            پزشک</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>



    <!-- انتقال امن داده‌های Django به جاوااسکریپت -->
    {{ days|json_script:"days-data" }}
    {{ doctor.id|json_script:"doctor-id" }}
    {{ doctor.consultation_fee|json_script:"consultation-fee" }}
    {{ balance|json_script:"wallet-balance" }}


{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/booking/booking-calendar.js' %}"></script>
{% endblock %}