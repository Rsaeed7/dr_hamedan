{% extends  'base/base.html' %}
{% load static %}
{% block title %}<title> دکتر {{ doctor.user.get_full_name }} | دکتر همدان</title>{% endblock %}
{% block style %}
<link href="{% static 'css/dr/detail.css' %}" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}
{% load persian_date %}
{% block body %}

    <!-- Search -->
    {% include  'base/search.html' %}
    <!-- /Search -->

    <div class="container margin_60">
        <div class="row">
            <div class="col-xl-8 col-lg-8">
                <section id="section_1">
                    <div>
                        <div class="profile box_general_3 border-0-m p-3">
                            <div class="row parent-container">
                                <div class="col-lg-12 col-md-4">
                                    <figure>
                                        {% if doctor.profile_image %}
                                            <a class="dr_box2"><img src="{{ doctor.profile_image.url }}"
                                                                    alt="{{ doctor.user.get_full_name }}"
                                                                    class="dr_img">
                                                <i class="icon-star-5 text-primary"><small>{{ doctor.comment_rate }}</small></i></a>
                                        {% else %}
                                            <a class="dr_box2">
                                                <div class="dr_img d-flex align-items-center justify-content-center bg-light text-muted"
                                                     style="width: 100%; height: 200px; font-size: 48px;">
                                                    <i class="icon-user-md"></i>
                                                </div>
                                                <i class="icon-star-5 text-primary"><small>{{ doctor.comment_rate }}</small></i>
                                            </a>
                                        {% endif %}
                                    </figure>
                                </div>
                                <div class="col-lg-12 col-md-12">
                                    <div class="text-center">
                                        <h1> دکتر {{ doctor.user.get_full_name }}</h1>
                                        <small>{{ doctor.specialization }}</small>
                                    </div>
                                    <button id="scrollButton"
                                            class="btn btn-comment btn-sm col-md-12 rounded-10 d-lg-none animation">نوبت
                                        دهی
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- /profile -->

                        <div>
                            <!--/nav-tabs -->
                            <div class="tab-content box_general_3 border-0-m p-3">
                                <div class="indent_title_in" style="margin: 0;padding: 0!important;">
                                    <i class="pe-7s-id"></i>
                                </div>
                                <ul class="nav center-content margin-10" role="tablist">
                                    <li>
                                        <a class="nav-link  active p_1" id="general-tab" data-toggle="tab"
                                           href="#general"
                                           role="tab" aria-controls="general" aria-expanded="true"> پزشک درباره</a>
                                    </li>
                                    <li>
                                        <a class="nav-link p_1" id="address-tab" data-toggle="tab" href="#address"
                                           role="tab" aria-controls="address">آدرس و تلفن</a>
                                    </li>
                                    <li>
                                        <a class="nav-link p_1" id="reviews-tab" data-toggle="tab" href="#reviews"
                                           role="tab" aria-controls="reviews"> نظرات</a>
                                    </li>
                                </ul>
                                <div class="tab-pane fade show active" id="general" role="tabpanel"
                                     aria-labelledby="general-tab">
                                    <div>
                                        <h3> دکتر {{ doctor.user.get_full_name }} </h3>
                                    </div>
                                    <div class="wrapper_indent">
                                        <p> {{ doctor.bio }} </p>
                                        <h6>خدمات تخصصی:</h6>
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <ul class="bullets">
                                                    {% for service in doctor.service.all %}
                                                        {% cycle 'start' '' as row silent %}
                                                        {% if row == 'start' %}
                                                            <li>{{ service.service }}</li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <div class="col-lg-6">
                                                <ul class="bullets">
                                                    {% for service in doctor.service.all %}
                                                        {% cycle '' 'start' as row silent %}
                                                        {% if row == 'start' %}
                                                            <li>{{ service.service }}</li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /tab_1 -->
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div>
                                        <h4> مطب دکتر {{ doctor.user.get_full_name }}</h4>
                                        <div class="indent_title_in m-t-15 border-0" style="padding-left: 0!important;">
                                            <i class="pe-7s-map-2"></i>
                                            {% if doctor.latitude and doctor.longitude %}
                                                <div style="position: relative; height: 125px; border-radius: 8px; overflow: hidden; ">
                                                    <iframe
                                                            width="100%"
                                                            style="border:0; max-height: 120px"
                                                            loading="lazy"
                                                            allowfullscreen
                                                            referrerpolicy="no-referrer-when-downgrade"
                                                            src="https://maps.google.com/maps?q={{ doctor.latitude }},{{ doctor.longitude }}&z=15&output=embed&hl=fa">
                                                    </iframe>
                                                    <div style="position: absolute; bottom: 10px; right: 10px;">
                                                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ doctor.latitude }},{{ doctor.longitude }}"
                                                           target="_blank"
                                                           class="btn btn-sm btn-primary"
                                                           style="padding: 5px 10px;">
                                                            مسیریابی
                                                        </a>
                                                    </div>
                                                </div>
                                                <p class="text-center text_dr_3">موقعیت مطب روی نقشه گوگل</p>
                                            {% else %}
                                                <p class="text-center text_dr_3">آدرس روش نقشه گوگل ثبت نشده است</p>
                                            {% endif %}
                                        </div>
                                        <p><i class="icon-location-outline"></i>{{ doctor.address }}</p>
                                        <p><i class="icon-phone-outline"></i>{{ doctor.phone }}</p>
                                    </div>
                                </div>


                                <!-- /tab_2 -->
                                <div class="tab-pane fade" id="reviews" role="tabpanel"
                                     aria-labelledby="reviews-tab">
                                    <div class="reviews-container">
                                        <div class="row margin_30_20 comment-rate">
                                            <div class="col-lg-4 border-left-pc">
                                                <h6 class="text-center text-white"><i
                                                        class="icon-star-5 text-warning"></i>{{ doctor.comment_rate }}
                                                </h6>
                                            </div>
                                            <div class="col-lg-4 border-left-pc">
                                                <h6 class="text-center text-white"><i
                                                        class="icon-thumbs-up-1 text-success"></i>{{ doctor.recommendation_percentage }}%
                                                    توصیه شده</h6>
                                            </div>
                                            <div class="col-lg-4">
                                                <h6 class="text-center text-white"><i
                                                        class="icon-hourglass-1 text-info"></i>انتظار {{ doctor.get_most_common_waiting_time }}
                                                </h6>
                                            </div>
                                            <div class="col-lg-12">
                                                <button class="btn btn-comment col-md-12" onclick="showFormModal()">ثبت
                                                    نظر
                                                </button>
                                            </div>
                                        </div>
                                        {% for comment in comments %}
                                            <div class="review-box clearfix">
                                                <div class="rev-content">
                                                    <div class="rev-header">
                                                        <div class="rev-info">{% if comment.user.first_name %}
                                                            {{ comment.user.get_full_name }}{% else %}کاربر دکتر
                                                            همدان{% endif %}</div>
                                                        <small>{{ comment.date|persian_date_info }}</small>
                                                        <div class="rating text-left">
                                                            {% for i in stars_range %}
                                                                <i class="{% if i <= comment.rate %}icon_star voted{% else %}icon_star{% endif %}"></i>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    <h6 class="{% if comment.recommendation == 'توصیه نمیکنم' %}text-danger{% else %}text-success{% endif %}">
                                                        <i class="{% if comment.recommendation == 'توصیه نمیکنم' %}icon-thumbs-down-1{% else %}icon-thumbs-up-1{% endif %}"></i>
                                                        پزشک را {{ comment.recommendation }}</h6>
                                                    <div class="rev-text">
                                                        <p>{{ comment.text }}</p>
                                                        <ul class="row">
                                                            {% for tip in comment.tips.all %}
                                                                <li class="rev-comment m-b-1">{{ tip }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>

                                                </div>
                                            </div>
                                        {% endfor %}

                                    </div>
                                </div>
                                <!-- /tab_3 -->
                            </div>
                            <div class="tab-content box_general_3 border-0-m p-3">
                                <div class="tab-pane fade show active m-t-5" role="tabpanel"
                                     aria-labelledby="general-tab">
                                    <div>
                                        <h6>آخرین پست های دکتر {{ doctor.user.get_full_name }}</h6>
                                    </div>
                                    <div class="masonry-container-gallery">
                                        {% for post in posts %}
                                            <div class="masonry-item-gallery">
                                                <a href="{% url 'docpages:post_detail' post.id %}" class="m-b-5">
                                                    {% if post.media_type == 'image' and post.image %}
                                                        <img src="{{ post.image.url }}"
                                                             alt="{{ post.title|default:'تصویر ' }}"
                                                             class="img-fluid rounded w-100"
                                                             style="max-height: 150px;min-height: 150px">
                                                    {% elif post.media_type == 'video' and post.video %}
                                                        <div class="video-thumbnail-container position-relative">
                                                            <video src="{{ post.video.url }}"
                                                                   class="img-fluid rounded w-100 bg-dark"
                                                                   style="max-height: 150px;min-height: 150px"
                                                                   preload="metadata"></video>
                                                            <!-- Video play overlay -->
                                                            <div class="video-overlay position-absolute d-flex align-items-center justify-content-center"
                                                                 style="top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3);">
                                                                <i class="fa fa-play-circle text-white"
                                                                   style="font-size: 2rem;"></i>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="img-fluid rounded w-100 bg-light d-flex align-items-center justify-content-center"
                                                             style="max-height: 150px;min-height: 150px">
                                                            <span class="text-muted">بدون رسانه</span>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                            </div>
                                        {% empty %}
                                            <p>هنوز تصویری بارگذاری نشده است!</p>
                                        {% endfor %}
                                    </div>

                                </div>
                                <a class="btn_1 col-12 text-center p-10 m-t-5 m-b-5" style="padding: 10px"
                                   href="{% url 'docpages:doctor_page' doctor.slug %}">مشاهده صفحه پزشک</a>
                            </div>
                            <!-- /tab-content -->
                        </div>
                    </div>
                </section>
            </div>
            <div id="formModal" class="modal hidden">
                <div class="modal-content">
                    <span class="close" onclick="closeFormModal()">&times;</span>
                    <form method="post" style="margin-top: 1px">
                        {% csrf_token %}
                        <h6 class="text-center m-b-10">ثبت نظر</h6>

                        <!-- بخش پیشنهاد -->
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <label class="form-label">آیا این پزشک را پیشنهاد میکنید؟</label>
                                <div class="recommendation-options">
                                    <div class="recommend-option">
                                        <input type="radio" id="recommended" name="recommendation"
                                               value="توصیه میکنم" class="form-check-input" checked>
                                        <label for="recommended"
                                               class="form-check-label recommend-label recommend-yes">پیشنهاد
                                            میکنم</label>
                                    </div>
                                    <div class="recommend-option">
                                        <input type="radio" id="not-recommended" name="recommendation"
                                               value="توصیه نمیکنم" class="form-check-input">
                                        <label for="not-recommended"
                                               class="form-check-label recommend-label recommend-no">پیشنهاد
                                            نمیکنم</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- بخش نکات مثبت و منفی -->
                        <div class="row mt-3 text-center">
                            <div class="col-12">
                                <label class="form-label">نکات مثبت و منفی از تجربه خود در مطب را انتخاب کنید</label>
                                <div class="compact-tips">
                                    {% for tip in tips %}
                                        <label class="compact-tip">
                                            <input type="checkbox" id="tips" name="tips" value="{{ tip.id }}"
                                                   class="tip-input">
                                            <span class="tip-content">{{ tip.tip }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- زمان انتظار در مطب -->
                        <div class="row mt-3 text-center">
                            <div class="col-12">
                                <label class="form-label">زمان انتظار شما در مطب چقدر بود؟</label>
                                <div class="compact-tips">
                                    <label class="compact-tip">
                                        <input type="radio" id="time" name="time" value="کمتر از نیم ساعت"
                                               class="tip-input">
                                        <span class="tip-content">کمتر از نیم ساعت</span>
                                    </label>
                                    <label class="compact-tip">
                                        <input type="radio" id="time" name="time" value="نیم تا یک ساعت"
                                               class="tip-input">
                                        <span class="tip-content">نیم تا یک ساعت</span>
                                    </label>
                                    <label class="compact-tip">
                                        <input type="radio" id="time" name="time" value="یک تا دو ساعت"
                                               class="tip-input">
                                        <span class="tip-content">یک تو دو ساعت</span>
                                    </label>
                                    <label class="compact-tip">
                                        <input type="radio" id="time" name="time" value="بیش از دو ساعت"
                                               class="tip-input">
                                        <span class="tip-content">بیش از دو ساعت</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- بخش امتیازدهی -->
                        <p class="text-center m-2"> به دکتر {{ doctor.user.get_full_name }} چه امتیازی میدهید؟</p>
                        <div class="star-ratings">
                            {% for i in stars_range %}
                                <input type="radio" name="rating" id="rate-{{ i }}" value="{{ i }}"
                                       {% if i == 4 %}checked{% endif %}>
                                <label for="rate-{{ i }}"><i class="fa fa-star"></i></label>
                            {% endfor %}
                        </div>


                        <!-- بخش متن نظر -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>نظرتان را در مورد پزشک بنویسید <span class="text-danger">*</span></label>
                                    <textarea name="text" class="form-control my-2" required></textarea>
                                    {% if messages %}
                                        {% for message in messages %}
                                            <small class="text-danger">{{ message }}</small>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-lg-12 centered">
                                <button type="submit" class="btn btn-info dr_bg m-t-20 w-full rounded">
                                    ثبت نظر
                                </button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>

            <aside class="col-xl-4 col-lg-4 " id="aside">
                <!--in person session -->
                <div class="box_general_3 border-0-m booking">
                    <div class="m-t-2 m-b-20">
                        <h6 class="text_dr_3"><i class="icon-user-add-outline"></i>دریافت نوبت حضوری</h6>
                        <small class="m-b-10 font-weight-bold"> <i
                                class="icon-location-outline"></i>{{ doctor.address }}
                        </small>

                    </div>

                    <div class="rev-header">

                        {% if doctor.get_first_available_day %}
                            <small class="rev-info text-sm-right">اولین نوبت خالی</small>
                            <small class="text-info">{{ doctor.get_first_available_day|persian_date_info }}</small>
                        {% else %}
                            <small class="text-danger centered font-weight-bold">فعلا نوبت خالی وجود ندارد</small>
                        {% endif %}
                    </div>

                    <a href="{% url 'reservations:book_appointment' doctor.slug %}"
                       class="btn btn-success col-lg-12 m-b-10 m-t-15">دریافت نوبت</a>
                </div>

                {% if doctor.online_visit %}
                    <!-- online consultation session -->
                    <div class="box_general_3 booking border-0-m">
                        <div class="m-t-2 m-b-20">
                            <h6 class="text_dr_3"><i class="icon-user-add-outline"></i>دریافت مشاوره متنی آنلاین</h6>
                            <small class="text_dr_3"> هزینه مشاوره {{ doctor.online_visit_fee }} هزار تومان </small>
                        </div>
                        <small class="rev-info text-sm-right">مشاوره متنی به مدت <span
                                class="text-info">30 دقیقه</span></small>
                        <button onclick="showFormChat()" class="btn btn-primary col-lg-12 m-b-10 m-t-15">دریافت
                            مشاوره متنی
                        </button>

                    </div>
                {% endif %}

            </aside>
            <!-- /asdide -->
        </div>
    </div>

    <div class="hidden" id="information">
        <div id="formModal" class="modal text-right">
            <div class="modal-content">
                <span class="close" onclick="closeFormChat()">&times;</span>
                <div id="booking-form">
                    <div class="alert alert-info mt-3">
                        رزرو ویزیت آنلاین <br>
                        هزینه ویزیت: {{ doctor.online_visit_fee }} تومان
                    </div>
                    <form method="post" id="booking-form" action="{% url 'chat:request_chat' doctor.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="patient_name" class="form-label">نام<span
                                            class="text-red">*</span></label>
                                    <input type="text" id="patient_name" name="patient_name"
                                           class="form-control"
                                           value="{% if user.first_name %}{{ user.first_name }}{% endif %}"
                                           required>
                                    <small class="text-danger font-weight-light"
                                           id="name_alarm"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="patient_last_name" class="form-label">نام
                                        خانوادگی<span class="text-red">*</span></label>
                                    <input type="text" id="patient_last_name" name="patient_last_name"
                                           class="form-control"
                                           value="{% if user.last_name %}{{ user.last_name }}{% endif %}"
                                           required>
                                    <small class="text-danger font-weight-light"
                                           id="last_name_alarm"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="patient_national_id" class="form-label">کد ملی</label>
                                    <input type="text" id="patient_national_id" name="patient_national_id"
                                           class="form-control"
                                           value="{% if user.patient.national_id %}{{ user.patient.national_id }}{% endif %}">
                                    <small class="text-danger font-weight-light"
                                           id="national_id_alarm"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone" class="form-label">شماره تماس<span
                                            class="text-red">*</span></label>
                                    <input type="tel" id="phone" name="phone"
                                           class="form-control" disabled
                                           value="{% if user.phone %}{{ user.phone }}{% endif %}">
                                    <small class="text-danger font-weight-light"
                                           id="phone_alarm"></small>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="disease_summary" class="form-label">خلاصه ای از علت مراجعه</label>
                                    <input type="text" id="disease_summary"
                                           name="disease_summary"
                                           class="form-control">
                                </div>
                            </div>

                            <!-- Payment Method Selection -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">روش پرداخت</label>
                                    <div class="payment-method-options">
                                        <div class="payment-option">
                                            <input type="radio" id="payment_direct" name="payment_method"
                                                   value="direct" checked>
                                            <label class="payment-option-label" for="payment_direct">
                                                <div class="payment-option-content">
                                                    <div class="payment-option-icon">
                                                        <i class="icon-credit-card"></i>
                                                    </div>
                                                    <div class="payment-option-text">
                                                        <div class="payment-option-title">پرداخت مستقیم</div>
                                                        <div class="payment-option-description">پرداخت آنلاین از طریق
                                                            کارت بانکی
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="payment-option">
                                            <input type="radio" id="payment_wallet" name="payment_method"
                                                   value="wallet">
                                            <label class="payment-option-label" for="payment_wallet">
                                                <div class="payment-option-content">
                                                    <div class="payment-option-icon">
                                                        <i class="icon-wallet"></i>
                                                    </div>
                                                    <div class="payment-option-text">
                                                        <div class="payment-option-title">پرداخت از کیف پول</div>
                                                        <div class="payment-option-description">از موجودی کیف پول
                                                            استفاده کنید
                                                        </div>
                                                        <div class="payment-option-balance" id="wallet-balance-display">
                                                            موجودی: <span
                                                                id="current-balance">{{ balance|floatformat:0 }}</span>
                                                            تومان
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <button type="submit" id="submit-btn"
                                class="btn btn-primary w-100">
                            رزرو ویزیت آنلاین
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div id="doctor-data"
         data-doctor-id="{{ doctor.id }}"
         data-doctor-name="{{ doctor.user.get_full_name|escapejs }}"
         data-online-fee="{{ doctor.online_visit_fee }}"
         data-chat-url="{% url 'chat:request_chat' doctor.id %}"
         data-register-url="{% url 'account:register' %}"
         data-is-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
    </div>


{% endblock %}

{% block extra_js %}
    <!-- برای tips و سایر داده‌های داینامیک -->
    <script id="tips-data" type="application/json">
        [
        {% for tip in tips %}
            {
                "id": "{{ tip.id }}",
            "text": "{{ tip.tip|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
        ]
    </script>
    <script src="{% static 'js/booking/booking-system.js' %}"></script>
{% endblock %}