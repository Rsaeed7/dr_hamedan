{% extends  'base/base.html' %}
{% load static %}
{% block body %}

<div class="container margin_60_35">
    <div class="row">
        <div class="col-lg-3">
            <div class="box_general_3 p-3">
                <div class="profile">
                    <div class="row text-center">
                        <div class="col-md-12">
                            <figure>
                                {% if doctor.profile_image %}
                                <img src="{{ doctor.profile_image.url }}" alt="Doctor" class="rounded-circle img-fluid" style="max-width: 150px;">
                                {% else %}
                                <img src="{% static 'img/dr/dr1.jfif' %}" alt="Doctor" class="rounded-circle img-fluid" style="max-width: 150px;">
                                {% endif %}
                            </figure>
                            <h3>{{ doctor.user.get_full_name }}</h3>
                            <p>{{ doctor.specialization }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-nav mt-4">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="{% url 'doctors:dashboard' %}"><i class="icon-th-large-outline"></i> داشبورد</a>
                        </li>
                        <li class="list-group-item">
                            <a href="{% url 'doctors:dashboard' %}?tab=appointments"><i class="icon-calendar-empty"></i> نوبت ها</a>
                        </li>
                        <li class="list-group-item active">
                            <a href="{% url 'doctors:analytics' %}"><i class="icon-chart-bar"></i> تحلیل عملکرد</a>
                        </li>
                        <li class="list-group-item">
                            <a href="{% url 'doctors:dashboard' %}?tab=earnings"><i class="icon-chart-line"></i> گزارش مالی</a>
                        </li>
                        <li class="list-group-item">
                            <a href="{% url 'doctors:dashboard' %}?tab=profile"><i class="icon-user-1"></i> پروفایل</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <div class="box_general_3">
                <!-- Analytics Header -->
                <div class="header_box">
                    <h2 class="d-inline-block">تحلیل عملکرد</h2>
                    <div class="filter float-left">
                        <select name="period" class="form-control">
                            <option value="month" {% if period == 'month' %}selected{% endif %}>30 روز اخیر</option>
                            <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>90 روز اخیر</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>یک سال اخیر</option>
                        </select>
                    </div>
                </div>
                
                <!-- Analytics Overview -->
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-calendar-check-o"></i> کل نوبت ها</h5>
                                <p class="card-text h3">{{ total_appointments }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-check-1"></i> نوبت های تکمیل شده</h5>
                                <p class="card-text h3">{{ completed_appointments }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-cancel"></i> نوبت های لغو شده</h5>
                                <p class="card-text h3">{{ cancelled_appointments }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-chart-pie"></i> نرخ تکمیل</h5>
                                <p class="card-text h3">{{ completion_rate }}%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Analytics -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="header_box">
                            <h3>تحلیل مالی</h3>
                        </div>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-wallet"></i> کل درآمد</h5>
                                <p class="card-text h3">{{ total_earnings }} تومان</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-chart-bar"></i> میانگین درآمد هر نوبت</h5>
                                <p class="card-text h3">{{ avg_earnings_per_appointment }} تومان</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Analytics -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="header_box">
                            <h3>تحلیل بیماران</h3>
                        </div>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-users"></i> تعداد بیماران</h5>
                                <p class="card-text h3">{{ unique_patients }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-user-plus"></i> نوبت های بیماران تکراری</h5>
                                <p class="card-text h3">{{ returning_patient_count }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="icon-chart-pie"></i> نسبت بیماران جدید</h5>
                                <p class="card-text h3">{{ new_patient_ratio }}%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Weekday Distribution -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="header_box">
                            <h3>توزیع نوبت ها بر اساس روزهای هفته</h3>
                        </div>
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Handle period change
    document.addEventListener('DOMContentLoaded', function() {
        const periodSelect = document.querySelector('select[name="period"]');
        if (periodSelect) {
            periodSelect.addEventListener('change', function() {
                window.location.href = `{% url 'doctors:analytics' %}?period=${this.value}`;
            });
        }
        
        // Weekday chart
        const ctx = document.getElementById('weekdayChart').getContext('2d');
        
        // Convert the weekday_distribution data for Chart.js
        const weekdays = ['دوشنبه', 'سه شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه', 'یکشنبه'];
        const dayData = Array(7).fill(0);
        
        {% for day in weekday_distribution %}
            dayData[{{ day.day__weekday }}] = {{ day.count }};
        {% endfor %}
        
        const weekdayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekdays,
                datasets: [{
                    label: 'تعداد نوبت ها',
                    data: dayData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(199, 199, 199, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}

{% endblock %} 